<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    
    <title>Water Around the World</title>

    <!-- Bulma.io for CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.7.2/css/bulma.css">

    <!-- Font Awesome Icons -->
    <script defer src="https://use.fontawesome.com/releases/v5.6.1/js/all.js" integrity="sha384-R5JkiUweZpJjELPWqttAYmYM1P3SNEJRM6ecTQF05pFFtxmCO+Y1CiUhvuDzgSVZ" crossorigin="anonymous"></script>

    <!-- D3.js for visualizations -->
    <script src="https://d3js.org/d3.v4.js"></script>
    <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="style.css">
  </head>
  <body>
    <!-- Hero with title and subtitle -->
    <section class="hero is-info is-medium">
      <div class="hero-body">
        <div class="columns">
          <div class="column is-12">
            <div class="container content has-text-centered">
              <h1 class="title is-size-1">Water Around the World</h1>
              <h2 class="subtitle is-size-2">Disparities in Urban and Rural Areas</h2>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Hero with Background and Purpose -->
    <section class="hero is-light">
      <div class="hero-body">
        <div class="container">
          <div class="columns">
            <div class="column is-offset-2 is-8">
            <h3 class="title is-size-3">Background and Purpose</h3>
              <p>With the use data from the AQUASTAT Database, this visualization aims to inform people of the disparities in drinking water around the world. Although clean drinking water is a necessity in life, not everyone has access to it, and there is an even clearer distinction between those living in urban and rural areas. This project uses a choropleth to geographically show the percentage of the population with clean drinking water for both urban and rural areas, which provides a better understanding of where the regions of water disparity are located. It also uses bar charts to help show the water disparity for selected countries of interest.</p>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Hero with choropleth -->
    <section class="hero">
      <div class="hero-body">
        <div class="container has-text-centered">
          <div class="columns">
            <div class="column is-offset-2 is-8">
              <h3 class="title is-size-3 has-text-left">Choropleth Map of Water Disparities Worldwide</h3>
            </div>
          </div>
          <div class="columns">
            <div class="column is-offset-3 is is-6">
              <article class="message is-info">
                <div class="message-header">
                  <p>Filter Options</p>>
                </div>
                <div class="message-body">
                  <!-- Radio buttons to select data -->
                  <label class="radio">
                      <input class="map-filter" type="radio" name="population" value="total" checked>
                      Total Population
                    </label>
                    <label class="radio">
                      <input class="map-filter" type="radio" name="population" value="urban">
                      Urban Population
                    </label>
                    <label class="radio">
                      <input class="map-filter" type="radio" name="population" value="rural">
                      Rural Population
                    </label>
                </div>
              </article>
            </div>
          </div>
              
          <div class="vis">
            <svg id="svgMap" width="1000" height="550"></svg>
          </div>
        </div>
  
      </div>
    </section>

    <!-- Hero with bar chart -->
    <section class="hero is-light">
      <div class="hero-body">
        <div class="container has-text-centered">
          <div class="columns">
            <div class="column is-offset-2 is-8">
              <h3 class="title is-size-3 has-text-left">Water Disparities in Selected Countries</h3>
            </div>
          </div>
          <div class="columns">
            <div class="column is-offset-1 is-4">
              <div class="vis">
                <svg id="svgBarChart" width="500" height="600"></svg>
              </div>
            </div>
  
            <!-- Display options box -->
            <div class="column is-offset-2 is-4">
              <article class="message is-info">
                <div class="message-header">
                  <p>Display Options</p>
                </div>
                <div class="message-body">
                  <p class="is-size-5">Sort Order</p>
                  <label class="radio">
                    <input class="chart-filter" type="radio" name="sort" value="ascending" checked>
                    Ascending
                  </label>
                  <label class="radio">
                    <input class="chart-filter" type="radio" name="sort" value="descending">
                    Descending
                  </label>
                  <br><br>
  
                  <p class="is-size-5">Number of Countries</p>
                  <div class="columns">
                    <div class="column is-offset-4 is-4">
                        <input class="chart-filter input" type="number" value="25" min="5" max="45" size="2">
                    </div>
                  </div>
  
                  <p class="is-size-5">Population Type</p>
                  <label class="radio">
                    <input class="chart-filter" type="radio" name="population-type" value="total" checked>
                    Total
                  </label>
                  <label class="radio">
                    <input class="chart-filter" type="radio" name="population-type" value="urban">
                    Urban
                  </label>
                  <label class="radio">
                    <input class="chart-filter" type="radio" name="population-type" value="rural">
                    Rural
                  </label>
                  <br><br>

                  <label class="checkbox">
                    <input class="chart-filter" type="checkbox" name="100-percent" checked>
                    Include countries with 100% access to safe drinking water
                  </label>
                  <br><br>
                </div>
              </article>
            </div>
          </div>
        </div>
      </div>

    </section>

    <script>
      // Define any URLs needed
      var GLOBAL_MAP_URL = "https://raw.githubusercontent.com/jchen2186/water-around-the-world/master/geojson/countries.geojson";
      var DRINKING_WATER_PERCENT_URL = "https://raw.githubusercontent.com/jchen2186/water-around-the-world/master/data/aquastat.csv";
      
      // Select objects from DOM
      var svgMap = d3.select("#svgMap");
      var gMap = svgMap.append("g")

      // let canvasSize = [svg.style("width"), svg.style("height")];
      var svgBarChart = d3.select("#svgBarChart");
      var gChart = svgBarChart.append("g");

      // Load the data and create the plots
      d3.queue()
        .defer(d3.json, GLOBAL_MAP_URL)
        .defer(d3.csv, DRINKING_WATER_PERCENT_URL)
        .await(createPlots);

      // Main function that creates all of the plots
      function createPlots(error, countries, waterData) {
        // Create chart
        createChart(gChart, waterData);

        // Create the map
        createMap(gMap, countries, waterData);
      }

      // Creates the initial bar charts
      function createChart(g, waterData) {
        let data = waterData.filter(function(row) {
          return row['Variable Name'] == "Total population with access to safe drinking-water (JMP)";
        }).map(row => {
          return [row['Area'],
                  row['Variable Name'],
                  parseInt(row['Year']),
                  parseFloat(row['Value'])];
        }).sort((x, y) => {
          return d3.ascending(x[3], y[3]);
        }).slice(0, 25);

        let maxValue = 100;
        let xShift = 250;
        
        // Generate x and y scaling for bar chart
        let x = d3.scaleLinear()
          .domain([0, maxValue])
          .rangeRound([0, 200]);
        
        let y = d3.scaleBand()
          .domain(data.map(d => d[0]))
          .rangeRound([50, 550]);
        
        // x-axis ticks and labels on the top
        g.append("g")
          .attr("class", "x-axis")
          .attr("transform", `translate(${xShift}, 50)`)
          .call(d3.axisTop(x)
            .ticks(4)
            .tickFormat(d3.format(".2s")));
        
        // x-axis ticks and labels on the bottom with the title of x-axis
        g.append("g")
          .attr("class", "x-axis")
          .attr("transform", `translate(${xShift}, 550)`)
          .call(d3.axisBottom(x)
            .ticks(4)
            .tickFormat(d3.format(".2s")))
          .append("text")
            .attr("class", "x-label")
            .attr("x", 100)
            .attr("y", 40)
            .text("% of Population with Access to Safe Drinking Water");

        // Add vertical grid lines
        g.append("g")
          .attr("class", "grid x-axis")
          .attr("transform", `translate(${xShift}, 50)`)
          .call(d3.axisTop(x)
            .ticks(4)
            .tickSize(-500)
            .tickFormat(""));
        
        // Afterwards, call updateChart() to fill chart with bars
        updateChart(g, waterData);

        // Update data and bar chart every time the options change
        d3.selectAll(".chart-filter")
          .on("change", function() {
            updateChart(g, waterData)
          });
      }

      // Helper function to get the options from the Display Options box
      function getChosenOptions() {
        let chartFilterElements = d3.selectAll(".chart-filter")._groups[0];
        let options = {};

        for (let i = 0; i < chartFilterElements.length; i++) {
          let el = chartFilterElements[i];
          if (el.type == "radio" && el.checked) {
            options[el.name] = el.value;
          }
          else if (el.type == "number") {
            options["numCountries"] = parseInt(el.value);
          }
          else if (el.type == "checkbox") {
            options[el.name] = el.checked;
          }
        }
        return options;
      }

      // Helper function to get the filtered data based on the Display Options box
      function getUpdatedData(g, waterData) {
        let options = getChosenOptions();
        let populationType = options["population-type"];
        let include100Percent = options["100-percent"];

        // Filter data based on the population and select top 25 descending order
        let data = waterData.filter(function(row) {
          if (include100Percent) {
            // Filter by population type
            if (populationType == "total") {
              return row["Variable Name"] == "Total population with access to safe drinking-water (JMP)";
            }
            else if (populationType == "urban") {
              return row["Variable Name"] == "Urban population with access to safe drinking-water (JMP)";
            }
            else if (populationType == "rural") {
              return row["Variable Name"] == "Rural population with access to safe drinking-water (JMP)";
            }
          }
          else {
            // Filter by population type, keeping only the ones that do not have 100%
            if (populationType == "total") {
              return row["Variable Name"] == "Total population with access to safe drinking-water (JMP)" && row["Value"] != "100";
            }
            else if (populationType == "urban") {
              return row["Variable Name"] == "Urban population with access to safe drinking-water (JMP)" && row["Value"] != "100";
            }
            else if (populationType == "rural") {
              return row["Variable Name"] == "Rural population with access to safe drinking-water (JMP)" && row["Value"] != "100";
            }
          }
        }).map(row => {
          return [row['Area'],
                  row['Variable Name'],
                  parseInt(row['Year']),
                  parseFloat(row['Value'])];
        })
        // Sort to the chosen option
        .sort((x, y) => {
          if (options["sort"] == "ascending") {
            return d3.ascending(x[3], y[3]);
          }
          else {
            return d3.descending(x[3], y[3]);
          }
        })
        // Select the number of countries as chosen
        .slice(0, options["numCountries"]);

        return data;
      }

      function updateChart(g, waterData) {
        let options = getChosenOptions();
        let data = getUpdatedData(g, waterData);
        let xShift = 250;
        let maxValue = 100;
        let t = d3.transition().duration(500);

        // Generate x and y scaling for bar chart
        let x = d3.scaleLinear()
          .domain([0, maxValue])
          .rangeRound([0, 200]);
        
        let y = d3.scaleBand()
          .domain(data.map(d => d[0]))
          .rangeRound([50, 550]);

        // Clear previous y-axis if any
        d3.selectAll("g.y-axis").remove();

        // y-axis ticks and labels
        g.append("g")
          .attr("class", "y-axis")
          .attr("transform", `translate(${xShift}, -2)`)
          .call(d3.axisLeft(y));

        // Enter, merge, and exit for bars
        let bars = g.selectAll(".bar")
          .data(data);

        bars.enter().append("rect")
          .attr("class", "bar")
          .attr("x", xShift)
          .attr("y", d => y(d[0]))
          .attr("width", 0)
          .style("opacity", 0)
        .merge(bars)
          .transition(t)
          .attr("x", xShift)
          .attr("y", d => y(d[0]))
          .attr("width", d => x(d[3]))
          .attr("height", (y.range()[1] - 100) / options["numCountries"])
          .style("opacity", 1);
        
        bars.exit()
          .transition(t)
          .style("opacity", 0);
      }
      
      // Creates the initial map, which contains the data for the total population
      function createMap(g, countries, waterData) {
        let data = waterData.filter(function(row) {
          return row['Variable Name'] == "Total population with access to safe drinking-water (JMP)";
        }).map(row => {
          return [row['Area'],
                  row['Variable Name'],
                  parseInt(row['Year']),
                  parseFloat(row['Value'])];
        });

        let projection = d3.geoMercator();
        
        let path = d3.geoPath()
          .projection(projection);
        
        // Draw outlines of the countries
        g.selectAll(".country")
          .data(countries.features)
          .enter()
          .append("path")
          .attr("class", "country")
          .attr("id", d => d.properties.name)
          .attr("d", path)
          .on("mouseover", showCountryInfo);
        
        let color = d3.scaleQuantize()
          .domain([0, 100])
          .range(d3.schemeBlues[9]);

        let x = d3.scaleLinear()
          .domain(d3.extent(color.domain()))
          .rangeRound([0, 400]);

        // Create the legend group
        let legend = g.append("g")
          .attr("class", "legend")
          .attr("transform", "translate(50, 500)");

        legend.selectAll("rect")
          .data(color.range().map(d => color.invertExtent(d)))
          .enter().append("rect")
            .attr("class", "legend-color-box")
            .attr("height", 5)
            .attr("x", d => x(d[0]))
            .attr("y", 0)
            .attr("width", d => x(d[1]) - x(d[0]))
            .attr("fill", d => color(d[0]));
        
        legend.append("text")
          .attr("class", "legend-title")
          .attr("x", x.range()[0])
          .attr("y", -6)
          .attr("fill", "Black")
          .attr("text-anchor", "start")
          .attr("font-weight", "bold")
          .text("Percentage of Population with Access to Safe Drinking Water");

        legend.call(d3.axisBottom(x)
          .tickSize(7)
          .tickFormat(d3.format(".1s"))
          .tickValues(color.range()
            .map(d => color.invertExtent(d)[0])))
          .select(".domain")
          .remove();

        // Draw last tick
        let lastTick = legend.append("g")
          .attr("class", "tick")
          .attr("opacity", 1)
          .attr("transform", "translate(400, 0)");

        lastTick.append("line")
          .attr("stroke", "#000")
          .attr("y2", 7);
        
        lastTick.append("text")
          .attr("fill", "#000")
          .attr("y", 10)
          .attr("dy", "0.71em")
          .text("100");
        
        // Draw initial info box
        var info = g.append("g")
          .attr("class", "info")
          .attr("transform", "translate(525, 460)");
        
        info.append("rect")
          .attr("class", "info-box")
          .attr("x", 0)
          .attr("y", 0)
          .attr("width", 400)
          .attr("height", 80);
        
        info.append("text")
          .attr("class", "info-text initial")
          .text(`Hover over each country for more info`)
          .attr("x", 40)
          .attr("y", 45);
        
        // Afterwards, call updateMap() to fill countries with color
        updateMap(g, waterData, "total");

        d3.selectAll(".map-filter")
          .on("change", function() {
            updateMap(g, waterData, this.value)
          });
      }

      function updateMap(g, waterData, dataType = "total") {
        // Filter data based on the population
        let data = waterData.filter(function(row) {
          if (dataType == "total") {
            return row['Variable Name'] == "Total population with access to safe drinking-water (JMP)";
          }
          else if (dataType == "rural") {
            return row['Variable Name'] == "Rural population with access to safe drinking-water (JMP)";
          }
          else if (dataType == "urban") {
            return row['Variable Name'] == "Urban population with access to safe drinking-water (JMP)";
          }
        }).map(row => {
          return [row['Area'],
                  row['Variable Name'],
                  parseInt(row['Year']),
                  parseFloat(row['Value'])];
        });

        let minValue = 0;
        let maxValue = 100;
        let steps = 9;
        
        let color = d3.scaleThreshold()
          .domain(d3.range(0, maxValue, maxValue / steps))
          .range(d3.schemeBlues[steps]);
        
        let countries = g.selectAll(".country")
          .data(data, d => d.properties ? d.properties.name : d[0]);

        let x = d3.scaleLinear()
          .domain([minValue, maxValue])
          .rangeRound([0, 500]);
        
        let legend = d3.selectAll(".legend");

        // Update the countries with their color
        countries.transition()
          .duration(300)
          .style("fill", d => color(d[3]));
        
        // Remove the previous info box
        d3.selectAll("rect.info-box").remove();
        d3.selectAll("text.info-text").remove();
        
        // Draw initial info box
        let info = d3.selectAll(".info");
        
        info.append("rect")
          .attr("class", "info-box")
          .attr("x", 0)
          .attr("y", 0)
          .attr("width", 400)
          .attr("height", 80);
        
        info.append("text")
          .attr("class", "info-text initial")
          .text(`Hover over each country for more info`)
          .attr("x", 40)
          .attr("y", 45);
      }

      function showCountryInfo(data) {
        // Remove the previous info box
        d3.selectAll("rect.info-box").remove();
        d3.selectAll("text.info-text").remove();
        
        let info = d3.selectAll(".info");
        
        info.append("rect")
          .attr("class", "info-box")
          .attr("x", 0)
          .attr("y", 0)
          .attr("width", 400)
          .attr("height", 80);
        
        info.append("text")
          .attr("class", "info-text")
          .text(`Country: ${data[0]}`)
          .attr("x", 20)
          .attr("y", 30);

        info.append("text")
          .attr("class", "info-text")
          .text(`${data[1].slice(0, -6)}: ${data[3]}%`)
          .attr("x", 20)
          .attr("y", 55);
      }
    </script>
  </body>
</html>