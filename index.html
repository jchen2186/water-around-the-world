<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    
    <title>Water Quality Worldwide</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.7.2/css/bulma.css">
    <script src="https://d3js.org/d3.v4.js"></script>
    <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>

    <link rel="stylesheet" href="style.css">
  </head>
  <body>
    <div id="chart">
      <svg width="1000" height="1500"></svg>

      <!-- Radio buttons to select data -->
      <form id="population-type">
        <input type="radio" name="population" value="total" checked> Total Population<br>
        <input type="radio" name="population" value="rural"> Rural Population<br>
        <input type="radio" name="population" value="urban"> Urban Population
      </form>
    </div>

    <script>
      // Define any URLs needed
      var GLOBAL_MAP_URL = "https://raw.githubusercontent.com/jchen2186/water-vis/master/geojson/countries.geojson?token=AFK5w0rbX2pqpKw1kIBfF7opY3u3f_eZks5cIY7VwA%3D%3D";
      var DRINKING_WATER_PERCENT_URL = "https://raw.githubusercontent.com/jchen2186/water-vis/master/data/aquastat.csv?token=AFK5w8m8-ZHURknPn35sBvRjaxNgcdGiks5cIZ0wwA%3D%3D";
      
      // Select objects from DOM
      var svg = d3.select("svg");
      let canvasSize = [svg.style("width"), svg.style("height")];
      var gChart = svg.append("g");
      var gMap = svg.append("g")
        .attr("transform", "translate(0, 900)");

      // Load the data and create the plots
      d3.queue()
        .defer(d3.json, GLOBAL_MAP_URL)
        .defer(d3.csv, DRINKING_WATER_PERCENT_URL)
        .await(createPlots);

      // Acts as the main function that creates all of the plots
      function createPlots(error, countries, waterData) {
        // Create chart
        createChart(gChart, waterData);

        // Create the map
        createMap(gMap, countries, waterData);
      }

      // Creates the initial bar charts
      function createChart(g, waterData) {
        let data = waterData.filter(function(row) {
          return row['Variable Name'] == "Total population with access to safe drinking-water (JMP)";
        }).map(row => {
          return [row['Area'],
                  row['Variable Name'],
                  parseInt(row['Year']),
                  parseFloat(row['Value'])];
        }).sort((x, y) => {
          return d3.ascending(x[3], y[3]);
        }).slice(0, 25);

        let maxValue = d3.max(data, d => d[3]);

        let xShift = 250;
        // console.log(maxValue);
        
        // Generate x and y scaling for bar chart
        let x = d3.scaleLinear()
          .domain([0, maxValue])
          .rangeRound([0, 300]);
        
        let y = d3.scaleBand()
          .domain(data.map(d => d[0]))
          .rangeRound([50, 550]);
        
        // y-axis ticks and labels
        g.append("g")
          .attr("class", "y-axis")
          .attr("transform", `translate(${xShift}, -2)`)
          .call(d3.axisLeft(y));

        // x-axis ticks and labels on the top
        g.append("g")
          .attr("class", "x-axis")
          .attr("transform", `translate(${xShift}, 50)`)
          .call(d3.axisTop(x)
            .ticks(4)
            .tickFormat(d3.format(".2s")));
        
        // x-axis ticks and labels on the bottom with the title of x-axis
        g.append("g")
          .attr("class", "axis--x")
          .attr("transform", `translate(${xShift}, 550)`)
          .call(d3.axisBottom(x)
            .ticks(4)
            .tickFormat(d3.format(".2s")))
          .append("text")
            .attr("id", "x-label")
            .attr("x", xShift / 3 * 2)
            .attr("y", 50)
            .text("Percentage");

        // add vertical grid lines
        g.append("g")
          .attr("class", "grid x-axis")
          .attr("transform", `translate(${xShift}, 50)`)
          .call(d3.axisTop(x)
            .ticks(4)
            .tickSize(-500)
            .tickFormat(""));

        // add bars for each cuisine and mouseover, mouseout, mousemove transitions
        g.selectAll(".bar")
        .data(data)
        .enter().append("rect")
          .attr("class", "bar")
          .attr("x", xShift)
          .attr("y", d => y(d[0]))
          .attr("width", d => x(d[3]))
          .attr("height", 18)
          .on("mouseover", function(d) {
            d3.select(this)
              .transition().ease(d3.easeBounce).duration(500)
              .attr("x", xShift - 8)
              .attr("y", d => y(d[0]) - 2)
              .attr("width", d => x(d[3]) + 16)
              .attr("height", y.bandwidth() + 2);
            updateMap(d);
          })
          .on("mouseout", function(d) {
            d3.select(this)
              .transition().duration(300)
              .attr("x", xShift)
              .attr("y", d => y(d[0]))
              .attr("width", d => x(d[3]))
              .attr("height", 18);
            d3.selectAll(".zip")
              .transition().duration(800)
              .style("fill", "none");
            d3.selectAll(".legend").style("visibility", "hidden");
          });
      }
      
      // Creates the initial map, which contains the data for the total population
      function createMap(g, countries, waterData) {
        let data = waterData.filter(function(row) {
          return row['Variable Name'] == "Total population with access to safe drinking-water (JMP)";
        }).map(row => {
          return [row['Area'],
                  row['Variable Name'],
                  parseInt(row['Year']),
                  parseFloat(row['Value'])];
        });

        let projection = d3.geoMercator();
        
        let path = d3.geoPath()
          .projection(projection);
        
        // Draw outlines of the countries
        g.selectAll(".country")
          .data(countries.features)
          .enter()
          .append("path")
          .attr("class", "country")
          .attr("id", d => d.properties.name)
          .attr("d", path)
          .on("mouseover", showCountryInfo);
        
        // Create the legend group
        g.append("g")
          .attr("class", "legend")
          .attr("transform", "translate(10, 500)")
          .append("text")
          .attr("class", "legend-text")
          .attr("x", 200)
          .attr("y", -6)
          .text("Percentage of Total Population with Access to Safe Drinking Water");
        
        // Draw initial info box
        var info = g.append("g")
          .attr("transform", "translate(600, 450)");
        
        info.append("rect")
          .attr("class", "info-box")
          .attr("x", 0)
          .attr("y", 0)
          .attr("width", 375)
          .attr("height", 50);
        
        info.append("text")
          .attr("class", "info-text")
          .text(`Hover over each country for more info.`)
          .attr("x", 5)
          .attr("y", 15);
        
        // Afterwards, call updateMap() to fill countries with color
        updateMap(g, waterData, "total");

        d3.selectAll("input")
          .on("change", function() {
            updateMap(g, waterData, this.value)
          });

      }

      function updateMap(g, waterData, dataType = "total") {
        // Filter data based on the population
        let data = waterData.filter(function(row) {
          if (dataType == "total") {
            return row['Variable Name'] == "Total population with access to safe drinking-water (JMP)";
          }
          else if (dataType == "rural") {
            return row['Variable Name'] == "Rural population with access to safe drinking-water (JMP)";
          }
          else if (dataType == "urban") {
            return row['Variable Name'] == "Urban population with access to safe drinking-water (JMP)";
          }
        }).map(row => {
          return [row['Area'],
                  row['Variable Name'],
                  parseInt(row['Year']),
                  parseFloat(row['Value'])];
        });

        let minValue = d3.min(data, d => d[3]);
        minValue = 0;
        let maxValue = d3.max(data, d => d[3]);
        let steps = 9;

        console.log(minValue);
        console.log(maxValue);
        
        let color = d3.scaleThreshold()
        // let color = d3.scaleQuantize()
          .domain(d3.range(minValue, maxValue, maxValue / steps))
          .range(d3.schemeBlues[steps]);
        
        let countries = g.selectAll(".country")
          .data(data, d => d.properties ? d.properties.name : d[0]);

        let x = d3.scaleLinear()
          .domain([minValue, maxValue])
          .rangeRound([0, 500]);
        
        let legend = d3.select(".legend");

        // Update the countries with their color
        countries.transition()
          .duration(300)
          .style("fill", d => color(d[3]));
        
        // Update the legend
        let boxes = legend.selectAll("rect")
          .data(color.range().map(function(d) {
            d = color.invertExtent(d);
            if (d[0]==null) d[0] = x.domain()[0];
            if (d[1]==null) d[1] = x.domain()[1];
            return d;
          }));

        boxes.enter()
          .append("rect")
          .merge(boxes)
            .attr("height", 6)
            .attr("x", d => x(d[0]))
            .attr("width", d => (x(d[1]) - x(d[0])))
            .attr("fill", d => color(d[0]));

        // Update the tick values
        legend.call(d3.axisBottom(x)
          .ticks(steps, "s")
          .tickSize(10,0)
          .tickValues(color.domain()))
          .select(".domain")
            .remove();
        
        
      }

      function showCountryInfo(data) {
        // Remove the previous info box
        d3.selectAll("rect.info-box").remove();
        d3.selectAll("text.info-text").remove();
        
        var info = gMap.append("g")
          .attr("transform", "translate(600, 450)");
        
        info.append("rect")
          .attr("class", "info-box")
          .attr("x", 0)
          .attr("y", 0)
          .attr("width", 375)
          .attr("height", 50);
        
        info.append("text")
          .attr("class", "info-text")
          .text(`Country: ${data[0]}`)
          .attr("x", 5)
          .attr("y", 15);

        info.append("text")
          .attr("class", "info-text")
          .text(`${data[1].slice(0, -6)}: ${data[3]}%`)
          .attr("x", 5)
          .attr("y", 30);
      }
    </script>
  </body>
</html>