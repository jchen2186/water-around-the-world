<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <link href="/d3-geomap/css/d3.geomap.css" rel="stylesheet">
    <script src="/d3-geomap/vendor/d3.geomap.dependencies.min.js"></script>
    <script src="/d3-geomap/js/d3.geomap.min.js"></script>
    <meta name="viewport" content="width=device-width">
    <title>Water Quality Worldwide</title>
    <!-- <script src="https://d3js.org/d3.v5.min.js"></script> -->
    <script src="https://d3js.org/d3.v4.js"></script>
    <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>



    <link rel="stylesheet" href="./style.css">
  </head>
  <body>
    <div id="map"></div>
    <div id="chart">
      <svg width="1000" height="500"></svg>
    </div>

    <script>
      // Define any URLs needed
      var GLOBAL_MAP_URL = "https://raw.githubusercontent.com/jchen2186/water-vis/master/geojson/countries.geojson?token=AFK5w0rbX2pqpKw1kIBfF7opY3u3f_eZks5cIY7VwA%3D%3D";
      var DRINKING_WATER_PERCENT_URL = "https://raw.githubusercontent.com/jchen2186/water-vis/master/data/aquastat.csv?token=AFK5w8m8-ZHURknPn35sBvRjaxNgcdGiks5cIZ0wwA%3D%3D";
      
      // Select objects from DOM
      var svg = d3.select("svg");
      var g = svg.append("g");

      // Load the world map
      d3.queue()
        .defer(d3.json, GLOBAL_MAP_URL)
        .await(createMap);
      
      function createMap(error, countries) {
        var canvasSize = [svg.style("width"), svg.style("height")];

        // var map = d3.geomap.choropleth()
        //   .geofile(GLOBAL_MAP_URL)
        //   .colors(colorbrewer.YlGnBu[9])
        //   .column('YR2010')
        //   .format(format)
        //   .legend(true)
        //   .unitId('iso3');


        var projection = d3.geoMercator();
          // .scale(110)
          // .translate([canvasSize[0] / 2, canvasSize[1] / 2]);
        
        var path = d3.geoPath()
          .projection(projection);
        
        var tooltip = d3.select("body")
          .append("div")
          .attr("class", "tooltip")
          .style("opacity", 0);
        
        var countries = g.selectAll(".country")
          .data(countries.features);
        
        countries.enter().append("path")
          .attr("class", "country")
          .attr("d", path)
          .on("click", countryClicked)
          .on("mouseover", d => {
            console.log("hello");
            tooltip.transition()
              .duration(100)
              .style("opacity", 0.9);
            tooltip.html(d[0] + ", " + d[3] + "%");
          })
          .on("mouseout", d => {
            console.log("goodbye");
            tooltip.transition()
              .duration(100)
              .style("opacity", 0);
          })
          .on("mousemove", d => {
            tooltip.style("top", d3.event.pageY - 15 + "px")
              .style("left", d3.event.pageX + 15 + "px")
          });
      }

      // Fill in colors in the map based on data
      d3.csv(DRINKING_WATER_PERCENT_URL, function(error, data) {
        var percent_drinking_water = data.filter(function(row) {
          return row['Variable Name'] == "Total population with access to safe drinking-water (JMP)";
        })
        .map(function(row) {
          return [row['Area'],
                  row['Variable Name'],
                  parseInt(row['Year']),
                  parseFloat(row['Value'])];
        })

        colorMap(percent_drinking_water);
      })

      function colorMap(data) {
        // console.log(data);

        // var minValue = d3.min(data, d => d[3]);
        var minValue = 0;
        // var maxValue = d3.max(data, d => d[3]);
        var maxValue = 100;
        var numColors = 9;

        var color = d3.scaleThreshold()
          .domain(d3.range(minValue, maxValue, maxValue / numColors))
          .range(d3.schemeBlues[numColors]);
        
        // Connect country name from geojson with country name from data set
        g.selectAll(".country")
          .data(data, key)
          .style("fill", d => color(d[3]));

        // Add legend for the scale
        var x = d3.scaleLinear()
          .domain([minValue, maxValue])
          .rangeRound([0, 490]);

        g.append("g")
          .attr("class", "legend")
          .attr("transform", "translate(75, 475)")
          .call(d3.axisBottom(x)
            .tickValues(d3.range(minValue, maxValue, maxValue / numColors))
            .tickFormat(d3.format(".0s"))
          ).append("text")
            .attr("id", "legendTitle")
            .attr("x", 200)
            .attr("y", -10)
            .text("Percentage of Population with Access to Safe Drinking Water");

        console.log(x.range()[1]);
        
        for (var i = 0; i < numColors - 1; i++) {
          g.append("g")
            .attr("class", "legendColorBar")
            .attr("transform", "translate(75, 475)")
            .append("rect")
              .attr("x", i * x.range()[1] / numColors)
              .attr("y", 0)
              .attr("width", x.range()[1] / numColors)
              .attr("height", 5)
              .style("fill", color(maxValue / (numColors - 1) * i));
        }
      }

      // Select key, name of country, from geojson file
      function key(d) {
        return d.properties ? d.properties.name : d[0];
      }

      function countryClicked(data) {
        // alert(data);

        var projection = d3.geoMercator();
        var pathCountry = d3.geoPath(projection);

        g.append("g")
          .attr("class", data[0])
          .attr("width", boundingArea.width)
          .attr("height", boundingArea.height)
          .selectAll("path")
            .data(data.geometries)
          .enter().append("path")
            .attr("d", pathCountry);
      }
    </script>
  </body>
</html>